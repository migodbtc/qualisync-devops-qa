name: Web Formatting, Linting, & Testing Automation
on: 
    push:
        branches:
            - main 
    pull_request:
        types: [opened, synchronize]

jobs: 
    lint:
        # Prettier & ESLint
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with: 
                node-version: 20.11

            - name: Enable & Prepare PNPM
              run: |
                corepack enable
                corepack prepare pnpm@9.0 --activate
            
            - name: Install PNPM globally as Fallback
              if: failure()
              run: npm install -g pnpm@9.0
            
            - name: NPM Package File & PNPM Lock File Checks
              run: |
                test -f package.json && echo "package.json found" || (echo "package.json missing!" && exit 1)
                test -f pnpm-lock.yaml && echo "pnpm-lock.yaml found" || (echo "pnpm-lock.yaml missing!" && exit 1)
              working-directory: web 

            - name: Install PNPM dependencies
              run: pnpm install --frozen-lockfile
              working-directory: web

            - name: Run Lint Check (Prettier)
              run: pnpm run format
              working-directory: web

            - name: Run Logic Check (ESLint)
              run: pnpm run lint
              working-directory: web
            
            - name: Run Build
              run: pnpm run build
              working-directory: web

            

    test: 
        # Component & Integration Tests
        runs-on: ubuntu-latest

        services:
            mysql:
                image: mysql:8.0
                env:
                    MYSQL_ALLOW_EMPTY_PASSWORD: yes
                ports:
                    - 3306:3306
                options: >-
                    --health-cmd="mysqladmin ping --silent"
                    --health-interval=10s
                    --health-timeout=5s
                    --health-retries=5

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            # ── Node / Frontend setup ──────────────────────────────────────
            - name: Setup Node.js
              uses: actions/setup-node@v4
              with: 
                node-version: 20.11

            - name: Enable & Prepare PNPM
              run: |
                corepack enable
                corepack prepare pnpm@9.0 --activate
            
            - name: Install PNPM globally as Fallback
              if: failure()
              run: npm install -g pnpm@9.0
            
            - name: NPM Package File & PNPM Lock File Checks
              run: |
                test -f package.json && echo "package.json found" || (echo "package.json missing!" && exit 1)
                test -f pnpm-lock.yaml && echo "pnpm-lock.yaml found" || (echo "pnpm-lock.yaml missing!" && exit 1)
              working-directory: web 

            - name: Install PNPM dependencies
              run: pnpm install --frozen-lockfile
              working-directory: web

            # ── Python / Backend setup ─────────────────────────────────────
            - name: Setup Python
              uses: actions/setup-python@v5
              with:
                python-version: 3.11

            - name: Install server dependencies
              run: |
                python -m pip install --upgrade pip
                pip install -r requirements.txt
              working-directory: server

            - name: Run database migrations
              run: |
                mysql -h 127.0.0.1 -u root < db/migrations/20260206_001_create_base_schema.sql
                mysql -h 127.0.0.1 -u root < db/migrations/20260206_002_create_jwt_auth_migration.sql
              working-directory: server

            - name: Start Flask server in background
              run: python main.py &
              working-directory: server

            - name: Wait for Flask server to be ready
              run: |
                for i in {1..30}; do
                  curl -sf http://localhost:5821/ && echo "Flask is up" && exit 0
                  echo "Waiting for Flask... ($i/30)"
                  sleep 2
                done
                echo "Flask failed to start" && exit 1

            # ── Environment configuration ──────────────────────────────────
            - name: Write web .env file
              run: |
                echo "NEXT_PUBLIC_FLASK_API_URL=http://localhost:5821" > web/.env
                echo "TEST_USER_EMAIL=${{ secrets.TEST_USER_EMAIL }}" >> web/.env
                echo "TEST_USER_PASSWORD=${{ secrets.TEST_USER_PASSWORD }}" >> web/.env

            # ── Tests ──────────────────────────────────────────────────────
            - name: Run component tests
              run: pnpm run test:component:run
              working-directory: web

            - name: Run integration tests
              run: pnpm run test:integration:run
              working-directory: web

            